<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CubeChat â€” Public (Smarter + Pixel Art)</title>

<style>
  :root{--bg:#071327;--card:#0b1220;--muted:#98b1d6;--player:#b8e0ff;--ai:#b7ffc9}
  body{font-family:Inter,system-ui,Arial;margin:18px;background:var(--bg);color:#e6eef8}
  .card{background:var(--card);padding:18px;border-radius:12px;max-width:980px;margin:12px auto;box-shadow:0 6px 30px rgba(0,0,0,.55)}
  h1{margin:0 0 8px;font-size:22px}
  #chat{height:520px;overflow:auto;padding:12px;border-radius:8px;background:#071427;margin-bottom:12px}
  .msg{margin:8px 0;white-space:pre-wrap;font-size:15px;line-height:1.4}
  .player{color:var(--player)}
  .ai{color:var(--ai)}
  input{flex:1;padding:10px;border-radius:8px;border:1px solid #1f2937;background:#071029;color:#e6eef8}
  button{padding:10px 14px;border-radius:8px;border:0;background:#12324a;color:#fff;cursor:pointer}
  button:hover{background:#174564}
  .notice{color:var(--muted);font-size:13px;margin-bottom:8px}

  /* SEARCH MODAL */
  #resultsModal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(0);opacity:0;background:#0b0b0b;padding:18px;border-radius:14px;width:92%;max-width:900px;max-height:80vh;overflow:auto;z-index:9999;transition:.2s}
  #resultsModal.show{transform:translate(-50%,-50%) scale(1);opacity:1}
  .resultItem{padding:12px;margin-bottom:10px;border-radius:10px;background:#111}

  /* PIXEL ART MODAL */
  #pixelModal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(0);opacity:0;background:#000;padding:20px;border-radius:14px;width:300px;z-index:10000;color:#fff;text-align:center;transition:.2s}
  #pixelModal.show{transform:translate(-50%,-50%) scale(1);opacity:1}
  canvas{width:256px;height:256px;image-rendering:pixelated;margin:10px auto}
</style>
</head>
<body>

<div class="card">
  <h1>CubeChat â€” Public</h1>
  <p class="notice">Chat, Search, & Generate Pixel Art! Try: <b>pixel</b> or <b>search: cats</b></p>

  <div id="chat"></div>

  <div style="display:flex;gap:8px">
    <input id="userInput" placeholder="Type your message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<!-- SEARCH -->
<div id="resultsModal">
  <div style="display:flex;justify-content:flex-end">
    <button id="closeResultsBtn">âœ–</button>
  </div>
  <div id="results"></div>
</div>

<!-- PIXELS -->
<div id="pixelModal">
  <div style="display:flex;justify-content:flex-end">
    <button id="closePixelBtn">âœ–</button>
  </div>
  <h3>Pixel Sprite</h3>
  <canvas id="pixelCanvas" width="16" height="16"></canvas>
  <button id="regenPixelBtn">New Sprite</button>
  <button id="downloadPixelBtn">Download</button>
</div>

<script>
// UI ELEMENTS
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const resultsModal = document.getElementById("resultsModal");
const resultsEl = document.getElementById("results");
const closeResultsBtn = document.getElementById("closeResultsBtn");

const pixelModal = document.getElementById("pixelModal");
const pixelCanvas = document.getElementById("pixelCanvas");
const regenPixelBtn = document.getElementById("regenPixelBtn");
const downloadPixelBtn = document.getElementById("downloadPixelBtn");
const closePixelBtn = document.getElementById("closePixelBtn");

let brain = null;

// LOAD BRAIN
async function loadBrain(){
  try{
    const r=await fetch("/brain");
    brain=await r.json();
    addChat("ai","Brain loaded! Ask me anything!");
  }catch{
    addChat("ai","âš  Brain not found!");
  }
}

// CHAT UI
function addChat(who,msg){
  const el=document.createElement("div");
  el.className="msg " + (who==="player"?"player":"ai");
  el.innerHTML = `<b>${who==="player"?"You":"CubeAI"}:</b> ${escapeHTML(msg)}`;
  chatEl.appendChild(el);
  chatEl.scrollTop=chatEl.scrollHeight;
}

function escapeHTML(x){
  return x.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

// BASIC INTENT MATCHER
function intent(text){
  const t=text.toLowerCase();
  for(const name in brain.intents){
    const obj=brain.intents[name];
    if(obj.triggers){
      for(const trig of obj.triggers){
        if(t.includes(trig.toLowerCase())) return name;
      }
    }
  }
  return "fallback";
}

// SEARCH API
async function doSearch(q){
  try{
    const r=await fetch(`/search?q=${encodeURIComponent(q)}`);
    const js=await r.json();
    return js.results||[];
  }catch{
    return[];
  }
}
function showResults(items){
  resultsEl.innerHTML="";
  items.forEach(r=>{
    const d=document.createElement("div");
    d.className="resultItem";
    d.innerHTML=`
      <strong>${escapeHTML(r.title)}</strong><br>
      <span style="color:#ccc">${escapeHTML(r.text?.slice(0,200)||"No preview")}</span><br>
      <a href="${r.url}" target="_blank">${escapeHTML(r.url)}</a>
    `;
    resultsEl.appendChild(d);
  });
  resultsModal.classList.add("show");
}

// PIXEL ART ENGINE
const pctx=pixelCanvas.getContext("2d");
function randomC(){return`#${Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6,"0")}`;}
function generatePixel(){
  pctx.clearRect(0,0,16,16);
  for(let y=0;y<16;y++){
    for(let x=0;x<8;x++){
      if(Math.random()>0.45){
        const c=randomC();
        pctx.fillStyle=c;
        pctx.fillRect(x,y,1,1);
        pctx.fillRect(15-x,y,1,1);
      }
    }
  }
}
function openPixel(){ pixelModal.classList.add("show"); generatePixel(); }
function closePixel(){ pixelModal.classList.remove("show"); }
function downloadPixel(){ const a=document.createElement("a"); a.download="pixel.png"; a.href=pixelCanvas.toDataURL(); a.click(); }

// MAIN HANDLER
async function handleMessage(text){
  if(!text)return;
  addChat("player",text);

  if(text.toLowerCase().includes("pixel")){
    addChat("ai","ðŸŽ¨ Generating pixel art!");
    return openPixel();
  }

  if(text.toLowerCase().startsWith("search:")){
    const q=text.slice(7).trim();
    addChat("ai","ðŸ” Searching...");
    const results=await doSearch(q);
    if(results[0]) addChat("ai",results[0].text);
    return showResults(results);
  }

  const i=intent(text);
  const obj=brain.intents[i];

  if(i==="fallback"){
    addChat("ai","Let me look that up...");
    const results=await doSearch(text);
    if(results[0]) addChat("ai",results[0].text);
    showResults(results);
  }else{
    const options=obj.responses;
    addChat("ai",options[Math.floor(Math.random()*options.length)]);
  }
}

// EVENTS
sendBtn.onclick=()=>{handleMessage(inputEl.value);inputEl.value="";};
inputEl.onkeydown=e=>{if(e.key==="Enter")sendBtn.onclick();};
closeResultsBtn.onclick=()=>resultsModal.classList.remove("show");

regenPixelBtn.onclick=generatePixel;
downloadPixelBtn.onclick=downloadPixel;
closePixelBtn.onclick=closePixel;

loadBrain();
</script>
</body>
</html>

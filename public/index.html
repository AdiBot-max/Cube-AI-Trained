<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CubeChat — Public (Adaptive extraction)</title>
<style>
  :root{--bg:#071327;--card:#0b1220;--muted:#98b1d6;--player:#b8e0ff;--ai:#b7ffc9}
  body{font-family:Inter,system-ui,Segoe UI,Arial;margin:18px;background:var(--bg);color:#e6eef8}
  .card{background:var(--card);padding:18px;border-radius:12px;max-width:980px;margin:12px auto;box-shadow:0 6px 30px rgba(0,0,0,.6)}
  h1{margin:0 0 8px;font-size:20px}
  #chat{height:520px;overflow:auto;padding:12px;border-radius:8px;background:#071427;margin-bottom:12px}
  .msg{margin:8px 0;white-space:pre-wrap}
  .player{color:var(--player)}
  .ai{color:var(--ai)}
  .controls{display:flex;gap:8px}
  input{flex:1;padding:10px;border-radius:8px;border:1px solid #1f2937;background:#071029;color:#e6eef8}
  button{padding:8px;border-radius:8px;border:0;background:#12324a;color:#fff}
  .notice{color:var(--muted);font-size:13px;margin-bottom:8px}
  #resultsModal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(0);background:#0b0b0b;color:#fff;padding:18px;border-radius:14px;width:92%;max-width:980px;max-height:80vh;overflow:auto;transition:transform .18s,opacity .18s;opacity:0;z-index:50}
  #resultsModal.show{transform:translate(-50%,-50%) scale(1);opacity:1}
  .resultItem{padding:12px;border-radius:10px;background:#111;margin-bottom:10px}
  .small{font-size:12px;color:#9fb1d6}
  .sourceLink{color:#4da6ff}
</style>
</head>
<body>
  <div class="card">
    <h1>CubeChat — Public</h1>
    <p class="notice">Adaptive extraction: short answers for simple queries, longer explanations for "how/why/explain". Use <b>search: your query</b> to force search & document extraction.</p>

    <div id="chat" aria-live="polite"></div>

    <div style="display:flex;gap:8px">
      <input id="userInput" placeholder="Type your message..." aria-label="message"/>
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <div id="resultsModal" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:flex-end"><button id="closeResults">✖</button></div>
    <div id="results"></div>
  </div>

<script>
const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const resultsModal = document.getElementById('resultsModal');
const resultsEl = document.getElementById('results');
const closeResults = document.getElementById('closeResults');

let brain = null;
let history = [];

// Load brain
async function loadBrain(){
  try {
    const res = await fetch('/brain');
    brain = await res.json();
    addSystem("Brain online");
  } catch {
    addSystem("Brain load error!");
  }
}

function escapeHTML(x){
  return x.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function addSystem(msg){
  const d=document.createElement('div');
  d.className='msg ai';
  d.textContent=msg;
  chatEl.appendChild(d);
  chatEl.scrollTop=chatEl.scrollHeight;
}

function addChat(who,msg){
  const d=document.createElement('div');
  d.className='msg ' + (who==='player'?'player':'ai');
  d.innerHTML = `<b>${who==='player'?'Player':'CubeAI'}:</b> ${escapeHTML(msg)}`;
  chatEl.appendChild(d);
  chatEl.scrollTop=chatEl.scrollHeight;
}

// Intent matcher
function predictIntent(text){
  const t=text.toLowerCase();
  for(const k in brain.intents){
    const data=brain.intents[k];
    if(!data.triggers) continue;
    for(const trig of data.triggers){
      if(typeof trig==="string" && t.includes(trig.toLowerCase())) return k;
    }
  }
  return "fallback";
}

// Search using EXA
async function doSearch(q){
  try {
    const r = await fetch(`/search?q=${encodeURIComponent(q)}`);
    if(!r.ok) throw new Error("search failed");
    const js = await r.json();
    return js.results || [];
  } catch(e){
    console.error("search error", e);
    return [];
  }
}

function showResults(items){
  resultsEl.innerHTML="";
  for(const r of items){
    const el=document.createElement("div");
    el.className="resultItem";
    el.innerHTML=`
      <div><strong>${escapeHTML(r.title || '')}</strong></div>
      <div style="color:#bbb">${escapeHTML(r.text || '')}</div>
      <div style="margin-top:4px"><a href="${r.url}" target="_blank">${escapeHTML(r.url)}</a></div>`;
    resultsEl.appendChild(el);
  }
  resultsModal.classList.add('show');
}

async function handleMessage(text){
  if(!text) return;

  addChat("player",text);
  history.push({who:"player",text});

  if(text.toLowerCase().startsWith("search:")){
    const q=text.slice(7).trim();
    addChat("ai","Searching...");
    const results=await doSearch(q);
    if(results[0]) addChat("ai",results[0].text || "No summary");
    showResults(results);
    return;
  }

  const intent=predictIntent(text);
  const intentObj=brain.intents[intent];

  if(!intentObj || intent==="fallback"){
    addChat("ai","Searching internet...");
    const results=await doSearch(text);
    if(results[0]) addChat("ai", results[0].text || "No result summary");
    showResults(results);
    return;
  }

  let reply=intentObj.responses[Math.floor(Math.random()*intentObj.responses.length)];

  if(intent==="math"){
    try {
      const safe=text.replace(/[^0-9+\-*/(). xX%]/g,'').replace(/x/gi,'*');
      reply=reply.replace("{solution}",Function("return ("+safe+")")());
    }catch{ reply=reply.replace("{solution}","Err"); }
  }

  addChat("ai",reply);
  history.push({who:"ai",text:reply});
}

sendBtn.onclick=()=>{handleMessage(inputEl.value.trim());inputEl.value="";inputEl.focus();};
inputEl.onkeydown=e=>{if(e.key==="Enter"){sendBtn.click();}};
closeResults.onclick=()=>resultsModal.classList.remove("show");

loadBrain();
</script>

</body>
</html>

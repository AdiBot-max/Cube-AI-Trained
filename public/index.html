<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CubeChat — Public</title>
<style>
  :root{
    --bg:#071327;
    --card:#0b1220;
    --muted:#98b1d6;
    --player:#b8e0ff;
    --ai:#b7ffc9;
  }
  body{
    font-family:Inter,system-ui,Segoe UI,Arial;
    margin:18px;
    background:var(--bg);
    color:#e6eef8;
  }
  .card{
    background:var(--card);
    padding:18px;
    border-radius:12px;
    max-width:980px;
    margin:12px auto;
    box-shadow:0 6px 30px rgba(0,0,0,.55);
  }
  h1{margin:0 0 8px;font-size:22px}
  #chat{
    height:500px;
    overflow:auto;
    padding:12px;
    border-radius:8px;
    background:#071427;
    margin-bottom:12px;
  }
  .msg{margin:8px 0;white-space:pre-wrap;font-size:15px;line-height:1.4}
  .player{color:var(--player)}
  .ai{color:var(--ai)}
  input{
    flex:1;
    padding:10px;
    border-radius:8px;
    border:1px solid #1f2937;
    background:#071029;
    color:#e6eef8;
  }
  button{
    padding:10px 14px;
    border-radius:8px;
    border:0;
    background:#12324a;
    color:#fff;
    cursor:pointer;
  }
  button:hover{background:#174564}

  .notice{color:var(--muted);font-size:13px;margin-bottom:8px}

  /* SEARCH MODAL */
  #resultsModal{
    position:fixed;
    left:50%;top:50%;
    transform:translate(-50%,-50%) scale(0);
    opacity:0;
    background:#0b0b0b;
    color:#fff;
    padding:18px;
    border-radius:14px;
    width:90%;
    max-width:900px;
    max-height:80vh;
    overflow:auto;
    z-index:9999;
    transition:transform .18s,opacity .18s;
  }
  #resultsModal.show{
    transform:translate(-50%,-50%) scale(1);
    opacity:1;
  }
  .resultItem{
    padding:12px;
    border-radius:10px;
    background:#111;
    margin-bottom:10px;
  }
</style>
</head>

<body>
  <div class="card">
    <h1>CubeChat — Public</h1>
    <p class="notice">Uses a hosted brain and cloud search. No training controls.</p>

    <div id="chat"></div>

    <div style="display:flex;gap:8px">
      <input id="userInput" placeholder="Type your message..." aria-label="message"/>
      <button id="sendBtn">Send</button>
    </div>

    <p class="notice">Tip: write <b>search: your text</b> to force a web search.</p>
  </div>

  <!-- SEARCH POPUP -->
  <div id="resultsModal">
    <div style="display:flex;justify-content:flex-end">
      <button id="closeResults">✖</button>
    </div>
    <div id="results"></div>
  </div>

<script>
const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const resultsModal = document.getElementById('resultsModal');
const resultsEl = document.getElementById('results');
const closeResults = document.getElementById('closeResults');

let brain = null;
let history = [];

// --------------------------------------------------------------------------
// LOAD BRAIN FROM SERVER
// --------------------------------------------------------------------------
async function loadBrain(){
  try {
    const res = await fetch('/brain');
    if(!res.ok) throw new Error('Failed loading brain.json');

    const text = await res.text();
    brain = JSON.parse(text.trim()); // prevents BOM crash

    addSystem("Brain loaded (" + Object.keys(brain.intents).length + " intents)");
  }
  catch(err){
    addSystem("Error loading brain: " + err.message);
  }
}

// --------------------------------------------------------------------------
// CHAT SYSTEM
// --------------------------------------------------------------------------
function addSystem(msg){
  const d = document.createElement('div');
  d.className = 'msg ai';
  d.textContent = msg;
  chatEl.appendChild(d);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function addChat(who,msg){
  const d = document.createElement('div');
  d.className = 'msg ' + (who === 'player' ? 'player' : 'ai');
  d.innerHTML = `<b>${who === 'player' ? 'Player' : 'CubeAI'}:</b> ` + escapeHTML(msg);
  chatEl.appendChild(d);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function escapeHTML(str){
  return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

// --------------------------------------------------------------------------
// INTENT MATCHING (simple substring match)
// --------------------------------------------------------------------------
function predictIntent(text){
  const t = text.toLowerCase();
  for(const intentName in brain.intents){
    const data = brain.intents[intentName];
    if(!data.triggers) continue;

    for(const trig of data.triggers){
      if(t.includes(trig.toLowerCase())) return intentName;
    }
  }
  return "fallback";
}

// --------------------------------------------------------------------------
// WEB SEARCH
// --------------------------------------------------------------------------
async function doSearch(q){
  try {
    const r = await fetch(`/search?q=${encodeURIComponent(q)}`);
    if(!r.ok) return [];
    const j = await r.json();
    return j.results || [];
  } catch {
    return [];
  }
}

function showResults(items){
  resultsEl.innerHTML = "";
  if(!items.length){
    resultsEl.innerHTML = "<div>No results.</div>";
  } else {
    for(const r of items){
      const d = document.createElement("div");
      d.className = "resultItem";
      d.innerHTML = `
        <div style="font-weight:700">${escapeHTML(r.title || "Result")}</div>
        <div style="color:#ccc">${escapeHTML(r.text || "")}</div>
        <a href="${escapeHTML(r.url)}" target="_blank">${escapeHTML(r.url)}</a>
      `;
      resultsEl.appendChild(d);
    }
  }
  resultsModal.classList.add("show");
}

// --------------------------------------------------------------------------
// REPLY HANDLER
// --------------------------------------------------------------------------
async function handleMessage(text){
  if(!text) return;

  addChat("player", text);
  history.push({who:"player", text});

  // Forced search
  if(text.toLowerCase().startsWith("search:")){
    const q = text.slice(7).trim();
    addChat("ai", "Searching: " + q);
    const r = await doSearch(q);
    showResults(r);
    return;
  }

  const intent = predictIntent(text);

  if(!brain.intents[intent]){
    addChat("ai","I'm not sure about that.");
    return;
  }

  let reply = brain.intents[intent].responses[
    Math.floor(Math.random()*brain.intents[intent].responses.length)
  ];

  // Math support
  if(intent === "math"){
    try {
      const safe = text.replace(/[^0-9+\-*/().xX ]/g,"")
                       .replace(/x/gi,"*");
      reply = reply.replace("{solution}", Function("return ("+safe+")")());
    }
    catch {
      reply = reply.replace("{solution}","I can't solve that.");
    }
  }

  addChat("ai", reply);
  history.push({who:"ai", text: reply});
}

// --------------------------------------------------------------------------
// EVENT LISTENERS
// --------------------------------------------------------------------------
sendBtn.onclick = () => {
  handleMessage(inputEl.value.trim());
  inputEl.value = "";
  inputEl.focus();
};
inputEl.addEventListener('keydown', e=>{
  if(e.key === "Enter"){
    sendBtn.click();
    e.preventDefault();
  }
});
closeResults.onclick = ()=>resultsModal.classList.remove("show");

loadBrain();
</script>
</body>
</html>

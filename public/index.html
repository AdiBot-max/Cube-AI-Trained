<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CubeChat — Turbo V3 (Client)</title>
<style>
  :root{--bg:#071327;--card:#0b1220;--muted:#98b1d6;--player:#b8e0ff;--ai:#b7ffc9}
  body{font-family:Inter,system-ui,Arial;margin:18px;background:var(--bg);color:#e6eef8}
  .card{background:var(--card);padding:18px;border-radius:12px;max-width:980px;margin:12px auto;box-shadow:0 6px 30px rgba(0,0,0,.55)}
  h1{margin:0 0 8px;font-size:20px}
  #chat{height:520px;overflow:auto;padding:12px;border-radius:8px;background:#071427;margin-bottom:12px}
  .msg{margin:8px 0;white-space:pre-wrap}
  .player{color:var(--player)}
  .ai{color:var(--ai)}
  input{flex:1;padding:10px;border-radius:8px;border:1px solid #1f2937;background:#071029;color:#e6eef8}
  button{padding:10px 14px;border-radius:8px;border:0;background:#12324a;color:#fff;cursor:pointer}
  .notice{color:var(--muted);font-size:13px;margin-bottom:8px}
  #candidatesModal, #resultsModal, #pixelModal { position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%) scale(0); opacity: 0; transition: .18s; z-index: 9999; background: #0b0b0b; padding: 16px; border-radius: 12px; width: 90%; max-width: 900px; max-height: 80vh; overflow: auto;}
  .show { transform: translate(-50%,-50%) scale(1); opacity: 1; }
  .candidate { padding:12px; border-radius:10px; background:#111; margin-bottom:8px; }
  canvas{width:256px;height:256px;image-rendering:pixelated; display:block; margin:10px auto}
</style>
</head>
<body>
  <div class="card">
    <h1>CubeChat — Turbo V3</h1>
    <p class="notice">Generative pipeline: understand → think → make 4 candidates → score → reply. Use <b>search: your query</b> for web lookup.</p>

    <div id="chat" aria-live="polite"></div>

    <div style="display:flex;gap:8px">
      <input id="userInput" placeholder="Type your message...">
      <button id="sendBtn">Send</button>
      <button id="candidatesBtn">Candidates</button>
    </div>
  </div>

  <!-- candidates modal -->
  <div id="candidatesModal" aria-hidden="true">
    <div style="display:flex;justify-content:flex-end"><button id="closeCandidates">✖</button></div>
    <h3 style="margin-top:0">Candidates (scored)</h3>
    <div id="candidatesList"></div>
  </div>

  <!-- results modal (search) -->
  <div id="resultsModal"><div style="display:flex;justify-content:flex-end"><button id="closeResults">✖</button></div><div id="resultsArea"></div></div>

  <!-- pixel modal -->
  <div id="pixelModal"><div style="display:flex;justify-content:flex-end"><button id="closePixel">✖</button></div><h3>Pixel Sprite</h3><canvas id="pixelCanvas" width="16" height="16"></canvas><div style="text-align:center"><button id="regen">New</button> <button id="download">Download</button></div></div>

<script>
const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const candidatesBtn = document.getElementById('candidatesBtn');
const candidatesModal = document.getElementById('candidatesModal');
const closeCandidates = document.getElementById('closeCandidates');
const candidatesList = document.getElementById('candidatesList');

const resultsModal = document.getElementById('resultsModal');
const closeResults = document.getElementById('closeResults');
const resultsArea = document.getElementById('resultsArea');

const pixelModal = document.getElementById('pixelModal');
const closePixel = document.getElementById('closePixel');
const regen = document.getElementById('regen');
const download = document.getElementById('download');
const pixelCanvas = document.getElementById('pixelCanvas');
const pctx = pixelCanvas.getContext('2d');
pixelCanvas.style.imageRendering = 'pixelated';

let lastCandidates = null;

function addChat(role, text){
  const d = document.createElement('div');
  d.className = 'msg ' + (role==='player' ? 'player' : 'ai');
  d.innerHTML = `<b>${role === 'player' ? 'Player' : 'CubeAI'}:</b> ${escapeHTML(text)}`;
  chatEl.appendChild(d);
  chatEl.scrollTop = chatEl.scrollHeight;
}
function addSystem(t){ addChat('ai', t); }

function escapeHTML(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* pixel */
function randomColor(){ const c = ["#00eaff","#0dc9f7","#005577","#33ffff","#99ffff"]; return c[Math.floor(Math.random()*c.length)]; }
function genPixel(){
  pctx.clearRect(0,0,16,16);
  for(let y=0;y<16;y++){
    for(let x=0;x<8;x++){
      if(Math.random()>0.45){
        const col = randomColor();
        pctx.fillStyle = col;
        pctx.fillRect(x,y,1,1);
        pctx.fillRect(15-x,y,1,1);
      }
    }
  }
}
function openPixel(){ pixelModal.classList.add('show'); genPixel(); }
function closePixelFn(){ pixelModal.classList.remove('show'); }
regen.onclick = genPixel;
download.onclick = ()=>{ const a=document.createElement('a'); a.href = pixelCanvas.toDataURL(); a.download = 'pixel.png'; a.click(); }

/* candidates modal */
candidatesBtn.onclick = ()=> candidatesModal.classList.add('show');
closeCandidates.onclick = ()=> candidatesModal.classList.remove('show');

/* results modal */
closeResults.onclick = ()=> resultsModal.classList.remove('show');

async function doSearch(q){
  try {
    const r = await fetch('/search?q='+encodeURIComponent(q));
    if(!r.ok) return [];
    const j = await r.json();
    return j.results || [];
  } catch (e) { return []; }
}

/* main: call /generate to get candidates + chosen */
async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value = '';
  addChat('player', text);

  // pixel shortcut
  if (text.toLowerCase().includes('pixel')) {
    addChat('ai','Generating pixel sprite...');
    openPixel();
    return;
  }

  // search: forced
  if (text.toLowerCase().startsWith('search:')) {
    addChat('ai','Searching...');
    const q = text.slice(7).trim();
    const results = await doSearch(q);
    if (results[0]) addChat('ai', results[0].text || 'Found something');
    resultsArea.innerHTML = results.map(r=>`<div><b>${escapeHTML(r.title)}</b><div>${escapeHTML(r.text)}</div><a href="${escapeHTML(r.url)}" target="_blank">${escapeHTML(r.url)}</a></div>`).join('<hr>');
    resultsModal.classList.add('show');
    return;
  }

  addChat('ai','Composing reply...');
  try {
    const res = await fetch('/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: text, maxTokens: 80 })
    });
    if (!res.ok) throw new Error('gen fail');
    const js = await res.json();
    lastCandidates = js.candidates || [];
    // chosen is first candidate returned
    const chosen = js.chosen || (lastCandidates[0] && lastCandidates[0].text) || "I don't know yet.";
    addChat('ai', chosen);

    // populate candidates modal
    candidatesList.innerHTML = '';
    (lastCandidates || []).forEach((c, idx) => {
      const el = document.createElement('div');
      el.className = 'candidate';
      el.innerHTML = `<div style="font-weight:700">${escapeHTML(c.label || ('cand'+(idx+1))) } — score ${escapeHTML(String(c.score || '0'))}</div>
                      <div style="white-space:pre-wrap;margin-top:6px">${escapeHTML(c.text || '')}</div>`;
      candidatesList.appendChild(el);
    });

  } catch (e) {
    console.error(e);
    addChat('ai','Generation failed — falling back to web search...');
    const results = await doSearch(text);
    if (results[0]) addChat('ai', results[0].text || 'Found something');
    resultsArea.innerHTML = results.map(r=>`<div><b>${escapeHTML(r.title)}</b><div>${escapeHTML(r.text)}</div><a href="${escapeHTML(r.url)}" target="_blank">${escapeHTML(r.url)}</a></div>`).join('<hr>');
    resultsModal.classList.add('show');
  }
}

sendBtn.onclick = sendMessage;
inputEl.onkeydown = (e)=>{ if (e.key === 'Enter') sendMessage(); };

/* start message */
addSystem('Loading brain & generator...');
fetch('/brain').then(r=>r.ok ? r.json() : Promise.reject()).then(j=>{
  addSystem('Brain ready!');
}).catch(()=> addSystem('⚠ Brain not found or failed to load.'));
</script>
</body>
</html>

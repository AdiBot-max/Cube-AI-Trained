<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CubeChat — Generative</title>

<style>
/* same UI as before */
:root{--bg:#071327;--card:#0b1220;--player:#b8e0ff;--ai:#b7ffc9;--muted:#8899cc}
body{margin:18px;font-family:system-ui;background:var(--bg);color:#e6eef8}
.card{background:var(--card);padding:18px;border-radius:12px;max-width:900px;margin:auto}
#chat{background:#071427;height:520px;overflow:auto;padding:12px;border-radius:8px}
.msg{margin:8px 0;white-space:pre-wrap}
.player{color:var(--player)}
.ai{color:var(--ai)}
button{padding:10px 14px;background:#12324a;color:#fff;border:0;border-radius:8px;cursor:pointer}
input{flex:1;padding:10px;background:#06101f;color:#eee;border-radius:8px;border:1px solid #123}
#resultsModal,#pixelModal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(0);opacity:0;transition:.2s;z-index:10;background:#000;padding:20px;border-radius:12px;width:90%;max-width:900px}
#resultsModal.show,#pixelModal.show{transform:translate(-50%,-50%) scale(1);opacity:1}
canvas{width:256px;height:256px;image-rendering:pixelated}
</style>
</head>
<body>

<div class="card">
  <h1>CubeChat — Generative</h1>
  <p style="color:var(--muted)">Say anything. I generate based on learning examples.</p>

  <div id="chat"></div>

  <div style="display:flex;gap:8px;margin-top:8px">
    <input id="userInput" placeholder="Message…">
    <button id="sendBtn">Send</button>
  </div>
</div>

<!-- SEARCH MODAL -->
<div id="resultsModal">
  <button id="closeResultsBtn">Close</button>
  <div id="results"></div>
</div>

<!-- PIXEL MODAL -->
<div id="pixelModal">
  <button id="closePixelBtn">Close</button>
  <h3>Pixel Sprite</h3>
  <canvas id="pixelCanvas" width="16" height="16"></canvas>
  <button id="regenPixelBtn">New Sprite</button>
  <button id="downloadPixelBtn">Download</button>
</div>

<script>
/*******************************************************
  DOM
*******************************************************/
const chatEl=document.getElementById("chat");
const inputEl=document.getElementById("userInput");
const sendBtn=document.getElementById("sendBtn");

const resultsModal=document.getElementById("resultsModal");
const resultsEl=document.getElementById("results");
const closeResultsBtn=document.getElementById("closeResultsBtn");

const pixelModal=document.getElementById("pixelModal");
const pixelCanvas=document.getElementById("pixelCanvas");
const regenPixelBtn=document.getElementById("regenPixelBtn");
const closePixelBtn=document.getElementById("closePixelBtn");
const downloadPixelBtn=document.getElementById("downloadPixelBtn");
const pctx=pixelCanvas.getContext("2d");

/*******************************************************
  Pixel Art
*******************************************************/
function randomColor(){
  const arr=["#00eaff","#0df","#099","#6ef","#ccf"];
  return arr[Math.floor(Math.random()*arr.length)];
}

function generatePixel(){
  pctx.clearRect(0,0,16,16);
  for(let y=0;y<16;y++){
    for(let x=0;x<8;x++){
      if(Math.random()>0.4){
        const c=randomColor();
        pctx.fillStyle=c;
        pctx.fillRect(x,y,1,1);
        pctx.fillRect(15-x,y,1,1);
      }
    }
  }
}

function openPixel(){ pixelModal.classList.add("show"); generatePixel(); }
function closePixel(){ pixelModal.classList.remove("show"); }

regenPixelBtn.onclick=generatePixel;
closePixelBtn.onclick=closePixel;
downloadPixelBtn.onclick=()=>{
  const a=document.createElement("a");
  a.href=pixelCanvas.toDataURL();
  a.download="pixel.png";
  a.click();
};

/*******************************************************
  Chat helpers
*******************************************************/
function addChat(role,msg){
  const el=document.createElement("div");
  el.className="msg "+(role==="player"?"player":"ai");
  el.textContent=(role==="player"?"Player: ":"CubeAI: ")+msg;
  chatEl.appendChild(el);
  chatEl.scrollTop=chatEl.scrollHeight;
}

/*******************************************************
  Brain Load
*******************************************************/
let brain=null;

async function loadBrain(){
  try{
    const r=await fetch("/brain");
    brain=await r.json();
    addChat("ai","Brain ready!");
  }catch{
    addChat("ai","⚠ Brain load failed.");
  }
}

/*******************************************************
  Intent detection = only picks examples, never answers
*******************************************************/
function predictIntent(txt){
  txt=txt.toLowerCase();
  for(const k in brain.intents){
    for(const t of brain.intents[k].triggers||[]){
      if(txt.includes(t.toLowerCase())) return k;
    }
  }
  return null;
}

/*******************************************************
  Search
*******************************************************/
async function doSearch(q){
  try{
    const r=await fetch(`/search?q=${encodeURIComponent(q)}`);
    if(!r.ok) return [];
    const j=await r.json();
    return j.results||[];
  }catch{return []}
}

function showResults(items){
  resultsEl.innerHTML="";
  items.forEach(r=>{
    const div=document.createElement("div");
    div.innerHTML=`<b>${r.title||""}</b><br>${r.text}`;
    resultsEl.appendChild(div);
  });
  resultsModal.classList.add("show");
}

closeResultsBtn.onclick=()=>resultsModal.classList.remove("show");

/*******************************************************
  MAIN HANDLE MESSAGE
*******************************************************/
async function handleMessage(text){
  if(!text.trim()) return;

  addChat("player", text);

  if(text.toLowerCase().includes("pixel")){
    addChat("ai","Generating pixel...");
    openPixel();
    return;
  }

  addChat("ai","Thinking...");

  const intent=predictIntent(text);
  let seed="";

  if(intent){
    const ex=brain.intents[intent].examples;
    if(ex && ex.length){
      seed=ex[Math.floor(Math.random()*ex.length)]+" ";
    }
  }

  // GENERATE ALWAYS
  try{
    const res=await fetch("/generate",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({prompt:seed+text, maxTokens:80})
    });

    const js=await res.json();
    const reply=js.reply?.trim();

    if(reply && reply.length>5){
      addChat("ai", reply);
      return;
    }

  }catch{}

  // SEARCH fallback
  addChat("ai","Searching...");
  const results=await doSearch(text);
  if(results[0]) addChat("ai", results[0].text);
  showResults(results);
}

/*******************************************************
  UI
*******************************************************/
sendBtn.onclick=()=>{ handleMessage(inputEl.value); inputEl.value=""; };
inputEl.onkeydown=e=>{ if(e.key==="Enter") sendBtn.click(); };

loadBrain();
</script>

</body>
</html>

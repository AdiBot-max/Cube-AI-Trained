<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CubeChat ‚Äî Public</title>

<style>
:root{
  --bg:#071327;--card:#0b1220;--player:#b8e0ff;--ai:#b7ffc9;--muted:#9fb1d6;
}
body{margin:18px;font-family:Inter,system-ui;background:var(--bg);color:#e6eef8}
.card{background:var(--card);padding:18px;border-radius:12px;max-width:980px;margin:12px auto}
#chat{height:500px;overflow:auto;background:#071427;border-radius:8px;padding:12px;margin-bottom:12px}
.msg{margin:6px 0;white-space:pre-wrap;font-size:15px}
.player{color:var(--player)}
.ai{color:var(--ai)}
input{flex:1;padding:10px;background:#071029;border:1px solid #1f2937;border-radius:8px;color:#e6eef8}
button{padding:10px 14px;border-radius:8px;background:#12324a;color:#fff;border:0;cursor:pointer}
button:hover{background:#184965}
.notice{color:var(--muted);font-size:13px}

/* popup */
#resultsModal{
  position:fixed;left:50%;top:50%;
  transform:translate(-50%,-50%) scale(0);
  opacity:0;background:#000;padding:14px;border-radius:14px;
  width:90%;max-width:800px;max-height:80vh;overflow:auto;
  transition:.2s;z-index:9999
}
#resultsModal.show{transform:translate(-50%,-50%) scale(1);opacity:1}
.resultItem{background:#111;border-radius:10px;padding:10px;margin:8px 0}
</style>
</head>

<body>
<div class="card">
  <h2>CubeChat ‚Äî Public</h2>
  <p class="notice">Ask anything! CubeAI extracts answers from the web if needed.</p>

  <div id="chat"></div>

  <div style="display:flex;gap:8px">
    <input id="userInput" placeholder="Ask me something..."/>
    <button id="sendBtn">Send</button>
  </div>
</div>

<div id="resultsModal">
  <button id="closeResults" style="float:right">‚úñ</button>
  <div id="results"></div>
</div>

<script>
const chatEl=document.getElementById("chat");
const inputEl=document.getElementById("userInput");
const sendBtn=document.getElementById("sendBtn");
const resultsModal=document.getElementById("resultsModal");
const resultsEl=document.getElementById("results");
const closeResults=document.getElementById("closeResults");

let brain=null;

//======== Load Brain
async function loadBrain(){
  const r=await fetch("/brain").catch(()=>{});
  if(!r||!r.ok) return addChat("ai","‚ùå Cannot load brain");
  brain=await r.json();
  addChat("ai","Brain Ready!");
}

//======== Chat UI
function addChat(who,msg){
  const d=document.createElement("div");
  d.className="msg "+(who=="player"?"player":"ai");
  d.innerHTML="<b>"+(who=="player"?"You":"CubeAI")+":</b> "+msg;
  chatEl.appendChild(d);
  chatEl.scrollTop=chatEl.scrollHeight;
}

//======== Intent Prediction
function predictIntent(text){
  const t=text.toLowerCase();
  for(const k in brain.intents){
    for(const trig of brain.intents[k].triggers){
      if(t.includes(trig.toLowerCase())) return k;
    }
  }
  return "fallback";
}

//======== Search + Extract Real Web Content
async function searchAndExtract(q){
  const s=await fetch("/search?q="+encodeURIComponent(q));
  const js=await s.json();

  if(!js.results.length){
    return addChat("ai","No info found");
  }

  const top=js.results[0];
  const e=await fetch("/extract?url="+encodeURIComponent(top.url));
  const info=await e.json();

  if(info.answer){
    addChat("ai",info.answer+"<br><br>üìå Source: "+info.title);
  }else{
    showLinks(js.results);
  }
}

//======== Popup fallback
function showLinks(arr){
  resultsEl.innerHTML="";
  arr.forEach(r=>{
    const d=document.createElement("div");
    d.className="resultItem";
    d.innerHTML=`<div>${r.title}</div><a href="${r.url}" target="_blank">${r.url}</a>`;
    resultsEl.appendChild(d);
  });
  resultsModal.classList.add("show");
}

//======== Message Handler
async function handleMessage(text){
  addChat("player",text);
  const intent=predictIntent(text);

  if(intent==="fallback"){
    return searchAndExtract(text);
  }
  
  let resp=brain.intents[intent].responses[
    Math.floor(Math.random()*brain.intents[intent].responses.length)
  ];
  addChat("ai",resp);
}

//======== UI Events
sendBtn.onclick = ()=>{handleMessage(inputEl.value);inputEl.value=""}
inputEl.addEventListener("keydown",e=>{
  if(e.key==="Enter"){sendBtn.click()}
});
closeResults.onclick=()=>resultsModal.classList.remove("show");

//======== Init
loadBrain();
</script>
</body>
</html>
